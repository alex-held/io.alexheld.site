<!doctype html><html lang=de><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, noarchive"><title>Alexander Held - How to refactor properly</title><link rel=icon href=https://alexheld.io/><meta name=description content="Das ist die deutsche Beschreibung"><link rel=alternate hreflang=en href=https://alexheld.io/posts/0001-how-to-refactor-properly/ title=en><link rel=alternate hreflang=de href=https://alexheld.io/de/posts/0001-how-to-refactor-properly/ title=de><meta name=generator content="Hugo 0.79.1"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to refactor properly"><meta name=twitter:description content="Let's refactor in small iterative steps a legacy Java Builder into a functional DSL."><meta property="og:title" content="How to refactor properly"><meta property="og:description" content="Let's refactor in small iterative steps a legacy Java Builder into a functional DSL."><meta property="og:type" content="article"><meta property="og:url" content="https://alexheld.io/de/posts/0001-how-to-refactor-properly/"><meta property="article:published_time" content="2020-12-22T07:10:42+01:00"><meta property="article:modified_time" content="2020-12-22T03:07:19+01:00"><meta property="og:site_name" content="Alexander Held"><meta property="og:locale" content="de"><meta property="og:locale:alternate" content="en"><link rel=stylesheet href=https://alexheld.io/css/bundle.min.css></head><body><header class="header has-LangNav"><div class=header__title><a href=/de/ class=header__title__link alt=Home>Alexander Held</a></div><nav class=menu aria-label=menu><ul class=menu__items aria-label=menu><li class=menu__items__item aria-label=Home><a href=/de/ class=menu__items__item__link alt=Home role=menuitem>Home</a></li><li class=menu__items__item aria-label=Blog><a href=/de/beitraege/ class=menu__items__item__link alt=Blog role=menuitem>Blog</a></li><li class=menu__items__item aria-label=Kontakt><a href=/de/kontakt/ class=menu__items__item__link alt=Kontakt role=menuitem>Kontakt</a></li><li class=menu__items__item aria-label=Lebenslauf><a href=/de/lebenslauf/ class=menu__items__item__link alt=Lebenslauf role=menuitem>Lebenslauf</a></li></ul></nav><nav class=hamburger-menu aria-label=mobile-menu><div class=toggle><input type=checkbox class=hamburger__toggle id=hamburgerToggle name="hamburger toggle" aria-label="Hamburguer menu">
<label class=hamburger__toggle__icon for=hamburgerToggle><i class="fas fa-bars"></i></label><ul class=hamburger__items aria-label=mobile-menu><li class=hamburger__items__item aria-label=Home><a href=/de/ class=hamburger__items__item__link alt=Home role=menuitem>Home</a></li><li class=hamburger__items__item aria-label=Blog><a href=/de/beitraege/ class=hamburger__items__item__link alt=Blog role=menuitem>Blog</a></li><li class=hamburger__items__item aria-label=Kontakt><a href=/de/kontakt/ class=hamburger__items__item__link alt=Kontakt role=menuitem>Kontakt</a></li><li class=hamburger__items__item aria-label=Lebenslauf><a href=/de/lebenslauf/ class=hamburger__items__item__link alt=Lebenslauf role=menuitem>Lebenslauf</a></li></ul></div></nav><nav class=LangNav><span><a href=/posts/0001-how-to-refactor-properly/>en</a></span>
<span class="active language">de</span></nav></header><article class=post><header class=post__header><h1 class=post__title>How to refactor properly</h1><p class=post__subtitle>Let's refactor in small iterative steps a legacy Java Builder into a functional DSL.</p><p class="post__date date">Tuesday, Dec, 2020 By Alexander Held.</p></header><main class=post__body><h2 id=r√ºckblick>R√ºckblick</h2><p>W√§hrend meines ersten Projektes an dem ich als Software Entickler gearbeitet habe, sollte ich einen microservice refactoren - alleine.</p><p>Wie ihr euch sicher denken k√∂nnt, kommt bei soetwas nur Schwachsinn raus. An manchen Stellen war es v√∂llig over-engineered und an anderen Stellen hat es an Kundenfeedback gefehlt. Achja und w√§hrend der gesamtem Zeit konnten wir den Service auch nicht deployen, da ja alles &ldquo;grade besser gemacht wird&rdquo;.</p><h2 id=das-muss-doch-besser-gehen->Das muss doch besser gehen üò§</h2><p>Unser Ziel ist es, den Builder einfacher lesbarer zu bekommen. Stellt euch vor wir w√ºrden in einer komplizierten Domaine unterwegs sein (z.B. AST oder ObjectGraphen generieren ). Da m√∂chte ich m√∂glichst schnell erkennen was dort grade vor sich geht und nicht an Builder Ketten entlanghangeln.</p><p><a href=https://github.com/alex-held/how-to-refactor-properly>SourceCode zum mitmachen</a></p><p>Wir beginnen unseren Ausflug hier mit dieser Ausgangslage.
<code>foo()</code> soll also einen <code>Client</code> bauen. Soweit to gut.</p><h6 id=builderexamplejava>BuilderExample.java</h6><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BuilderExample</span> <span style=color:#f92672>{</span>

 <span style=color:#66d9ef>public</span> Client <span style=color:#a6e22e>foo</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>

  var builder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ClientBuilder<span style=color:#f92672>();</span>
  builder<span style=color:#f92672>.</span><span style=color:#a6e22e>setFirstName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Alexander&#34;</span><span style=color:#f92672>);</span>
  builder<span style=color:#f92672>.</span><span style=color:#a6e22e>setLastName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Held&#34;</span><span style=color:#f92672>);</span>

  var twitterBuilder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TwitterBuilder<span style=color:#f92672>();</span>
  twitterBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>setHandle</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;0_alexheld&#34;</span><span style=color:#f92672>);</span>
  var twitter <span style=color:#f92672>=</span> twitterBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
  builder<span style=color:#f92672>.</span><span style=color:#a6e22e>setTwitter</span><span style=color:#f92672>(</span>twitter<span style=color:#f92672>);</span>

  var companyBuilder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CompanyBuilder<span style=color:#f92672>();</span>
  companyBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>setName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;MegaCorp&#34;</span><span style=color:#f92672>);</span>
  companyBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>setCity</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cologne&#34;</span><span style=color:#f92672>);</span>
  var company <span style=color:#f92672>=</span> companyBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
  builder<span style=color:#f92672>.</span><span style=color:#a6e22e>setCompany</span><span style=color:#f92672>(</span>company<span style=color:#f92672>);</span>

  <span style=color:#66d9ef>return</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
 <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><p>Lass uns loslegen, indem wir uns die Funktionalit√§t aus <code>BuilderExample.java</code> kopieren und nach Kotlin portieren.</p><h6 id=mainkt>main.kt</h6><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createClientInternal</span>(fn: String, ln: String, twitter: String, city: String, company: String): Client {
 <span style=color:#66d9ef>val</span> builder = ClientBuilder()
 builder.firstName = fn
 builder.lastName = ln

 <span style=color:#66d9ef>val</span> twitterBuilder = TwitterBuilder()
 twitterBuilder.handle = twitter
 builder.twitter = twitterBuilder.build()

 <span style=color:#66d9ef>val</span> companyBuilder = CompanyBuilder()
 companyBuilder.city = city
 companyBuilder.name = company
 builder.company = companyBuilder.build()

 <span style=color:#66d9ef>return</span> builder.build()
}
</code></pre></div><p>Wir k√∂nnen am effizentesten immer wieder kleine Verbesserungen machen und experimentieren wenn wir uns darauf verlassen k√∂nnen, dass wir Fehler schnell bemerken. Deswegen decken wir die Grundfunktionalit√§t grob mit Tests ab.</p><h6 id=mainkttestkt>MainKtTest.kt</h6><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#a6e22e>@Test</span>
<span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createClientInternal</span>() {
 <span style=color:#66d9ef>val</span> expected = Client(<span style=color:#e6db74>&#34;Alexander&#34;</span>, <span style=color:#e6db74>&#34;Held&#34;</span>, Company(<span style=color:#e6db74>&#34;MegaCorp&#34;</span>, <span style=color:#e6db74>&#34;Cologne&#34;</span>), Twitter(<span style=color:#e6db74>&#34;0_alexheld&#34;</span>))

 <span style=color:#66d9ef>val</span> result = createClientInternal(
  expected.firstName,
  expected.lastName,
  expected.twitter.handle,
  expected.company.city,
  expected.company.name
 )

 assertEquals(expected.firstName, result.firstName)
 assertEquals(expected.lastName, result.lastName)
 assertEquals(expected.twitter.handle, result.twitter.handle)
 assertEquals(expected.company.name, result.company.name)
 assertEquals(expected.company.city, result.company.city)
}
</code></pre></div><p>W√§hrend dem schreiben der Tests f√§llt auf, dass wir um die Clients im Debugger besser von einander unterscheiden zu k√∂nnen uns eine kleine Hilfsfunktion bauen.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>Client</span>.toConsoleString(): String {
 <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${twitter.handle}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${company.name}</span><span style=color:#e6db74>&#34;</span>
}
</code></pre></div><p><code>toConsoleString()</code> erf√ºllt zwar ihren Zweck, aber nur wenn ich ich die Funktion aufrufe.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>val</span> Client.consoleString: String
 <span style=color:#66d9ef>get</span>() = <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${twitter.handle}</span><span style=color:#e6db74> </span><span style=color:#e6db74>${company.name}</span><span style=color:#e6db74>&#34;</span>
</code></pre></div><p>So ists besser und l√§sst sich auch ganz simpel testen üëçüèª
Gleichzeitig haben wir uns noch eine Test Hilfsfunktion gebaut um nicht in jedem Test code zu duplizieren.</p><h6 id=mainkttestkt-1>MainKtTest.kt</h6><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>private</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createSubject</span>(
  fn: String = <span style=color:#e6db74>&#34;Alexander&#34;</span>,
  ln: String = <span style=color:#e6db74>&#34;Held&#34;</span>,
  twitter: String = <span style=color:#e6db74>&#34;0_alexheld&#34;</span>,
  city: String = <span style=color:#e6db74>&#34;Cologne&#34;</span>,
  company: String = <span style=color:#e6db74>&#34;MegaCorp&#34;</span>,
 ): Client = Client(fn, ln, Company(company, city), Twitter(twitter))

<span style=color:#a6e22e>@Test</span>
 <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>consoleString_should_return_correct_description</span>(){
  <span style=color:#66d9ef>val</span> expected = <span style=color:#e6db74>&#34;0_alexheld MegaCorp&#34;</span>
  <span style=color:#66d9ef>val</span> subject = createSubject()

  <span style=color:#66d9ef>val</span> actual = subject.consoleString

  assertEquals(expected, <span style=color:#66d9ef>actual</span>)
 }
</code></pre></div><p>Okay. Wir k√∂nnten anstelle von neue Builder mitten in der Business-Logik zu erzeugen, einfach nur Funktionen weiterreichen, die irgendwann lazy den Client bauen. Somit h√§tten wir Business Logik bei BusinessLogik und Funktionen bei Funktionen. Das Stichwort ist hier <a href=https://de.wikipedia.org/wiki/Koh%C3%A4renz_(Physik)>Koh√§renz</a>.</p><p><img src=./images/consumer_interface.png alt="Consumer Interface">
Wir √ºbergeben <code>createClient</code> als Parameter die Funktion <code>accept(cb: ClientBuilder)</code> mit der der <code>ClientBuilder</code> dann konfiguriert werden kann.</p><h6 id=mainkt-1>main.kt</h6><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createClient</span>(c: Consumer&lt;ClientBuilder&gt;): Client {
 <span style=color:#66d9ef>val</span> builder = ClientBuilder()
 c.accept(builder)
 <span style=color:#66d9ef>return</span> builder.build()
}
</code></pre></div><p>Der n√§chste Schritt ist es <code>createClient</code> aufzurufen. Dazu definieren wir inline ein <code>object</code> dass <code>Consumer&lt;ClientBuilder></code> implementiert. Hierzu m√ºssen wir <code>accept(builder: ClientBuilder)</code> √ºberschreiben.</p><h6 id=mainkt-2>main.kt</h6><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createClientInternal</span>(): Client {
 <span style=color:#66d9ef>return</span> createClient(
<span style=display:block;width:100%;background-color:#3c3d38>  <span style=color:#66d9ef>object</span>: Consumer&lt;ClientBuilder&gt; {
</span><span style=display:block;width:100%;background-color:#3c3d38>   <span style=color:#66d9ef>override</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>accept</span>(builder: ClientBuilder) {
</span>    builder.firstName = <span style=color:#e6db74>&#34;Alexander&#34;</span>
    builder.lastName = <span style=color:#e6db74>&#34;Held&#34;</span>

    <span style=color:#66d9ef>val</span> twitterBuilder = TwitterBuilder()
    twitterBuilder.handle = <span style=color:#e6db74>&#34;0_alexheld&#34;</span>
    builder.twitter = twitterBuilder.build()

    <span style=color:#66d9ef>val</span> companyBuilder = CompanyBuilder()
    companyBuilder.city = <span style=color:#e6db74>&#34;Cologne&#34;</span>
    companyBuilder.name = <span style=color:#e6db74>&#34;MegaCorp&#34;</span>
    builder.company = companyBuilder.build()
   }

  }
 )
}
</code></pre></div><p>Jetzt kriegen wir aber von den Tests einen auf den Deckel. Wir f√ºgen hier schnell eine Hilfsmethode hinzu die uns den ben√∂tigten <code>Consumer&lt;ClientBuilder></code> herstellt. Sch√∂n muss die nicht sein, die wird nur tempor√§r da sein. (Wie das meisste hier..)</p><h6 id=mainkttestkt-2>MainKtTest.kt</h6><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:block;width:100%;background-color:#3c3d38> <span style=color:#66d9ef>private</span> <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createConsumer</span>(): Consumer&lt;ClientBuilder&gt; {
</span>  <span style=color:#66d9ef>return</span> Consumer&lt;ClientBuilder&gt; {
   <span style=color:#66d9ef>it</span>.firstName = <span style=color:#e6db74>&#34;Alexander&#34;</span>
   <span style=color:#66d9ef>it</span>.lastName = <span style=color:#e6db74>&#34;Held&#34;</span>
   <span style=color:#66d9ef>it</span>.twitter = Twitter(<span style=color:#e6db74>&#34;0_alexheld&#34;</span>)
   <span style=color:#66d9ef>it</span>.company = Company(<span style=color:#e6db74>&#34;MegaCorp&#34;</span>, <span style=color:#e6db74>&#34;Cologne&#34;</span>)
  }
 }

 <span style=color:#a6e22e>@Test</span>
 <span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createClient_should_return_client_with_same_values</span>() {
  <span style=color:#66d9ef>val</span> expected = defaultClient

<span style=display:block;width:100%;background-color:#3c3d38>  <span style=color:#66d9ef>val</span> actual = createClient(createConsumer())
</span>
  assertEquals(expected.firstName, <span style=color:#66d9ef>actual</span>.firstName)
  assertEquals(expected.lastName, <span style=color:#66d9ef>actual</span>.lastName)
  assertEquals(expected.twitter.handle, <span style=color:#66d9ef>actual</span>.twitter.handle)
  assertEquals(expected.company.name, <span style=color:#66d9ef>actual</span>.company.name)
  assertEquals(expected.company.city, <span style=color:#66d9ef>actual</span>.company.city)
 }
</code></pre></div><p>Wir machen aus der inline <code>Consumer&lt;ClientBuilder></code> Implentiertung eine lambda. <code>builder</code> √ºbernimmt weiterhin die selbe Rolle: Konfiguration des <code>ClientBuilders</code>.</p><h6 id=mainkt-3>main.kt</h6><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createClientInternal</span>(): Client {
<span style=display:block;width:100%;background-color:#3c3d38> <span style=color:#66d9ef>return</span> createClient(
</span><span style=display:block;width:100%;background-color:#3c3d38>  Consumer { builder <span style=color:#f92672>-&gt;</span>
</span><span style=display:block;width:100%;background-color:#3c3d38>   builder.firstName = <span style=color:#e6db74>&#34;Alexander&#34;</span>
</span>   builder.lastName = <span style=color:#e6db74>&#34;Held&#34;</span>

   <span style=color:#66d9ef>val</span> twitterBuilder = TwitterBuilder()
   twitterBuilder.handle = <span style=color:#e6db74>&#34;0_alexheld&#34;</span>
   builder.twitter = twitterBuilder.build()

   <span style=color:#66d9ef>val</span> companyBuilder = CompanyBuilder()
   companyBuilder.name = <span style=color:#e6db74>&#34;MegaCorp&#34;</span>
   builder.company = companyBuilder.build()
  }
 )
}
</code></pre></div><p><code>builder</code> bennenen wir um nach <code>it</code>.
<a href=https://discuss.kotlinlang.org/t/it-keyword/6869>it</a> hat in kotlin eine besondere Bedeutung. Es ist quasi der default &lsquo;Name&rsquo;, wenn es nur einen Lamda Argument gibt.</p><h6 id=mainkt-4>main.kt</h6><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createClientInternal</span>(): Client {
 <span style=color:#66d9ef>return</span> createClient(
<span style=display:block;width:100%;background-color:#3c3d38>  Consumer { <span style=color:#66d9ef>it</span> <span style=color:#f92672>-&gt;</span>
</span><span style=display:block;width:100%;background-color:#3c3d38>   <span style=color:#66d9ef>it</span>.firstName = <span style=color:#e6db74>&#34;Alexander&#34;</span>
</span><span style=display:block;width:100%;background-color:#3c3d38>   <span style=color:#66d9ef>it</span>.lastName = <span style=color:#e6db74>&#34;Held&#34;</span>
</span>
   <span style=color:#66d9ef>val</span> twitterBuilder = TwitterBuilder()
   twitterBuilder.handle = <span style=color:#e6db74>&#34;0_alexheld&#34;</span>
<span style=display:block;width:100%;background-color:#3c3d38>   <span style=color:#66d9ef>it</span>.twitter = twitterBuilder.build()
</span>
   <span style=color:#66d9ef>val</span> companyBuilder = CompanyBuilder()
   companyBuilder.name = <span style=color:#e6db74>&#34;MegaCorp&#34;</span>
<span style=display:block;width:100%;background-color:#3c3d38>   <span style=color:#66d9ef>it</span>.company = companyBuilder.build()
</span>  }
 )
}
</code></pre></div><p>Dann l√∂schen wir <code>it</code> doch mal. Und die Lambda Pfeile brauchen wir durch <code>it</code> auch nicht mehr. Wir k√∂nnen <code>it</code> aber trotzdem im scope benutzen wir wir wollen. Der Kompiler wei√ü was abgeht.</p><p><img src=./images/it_lamda_default.png alt="it ide-syntax hightlighting"></p><h6 id=mainkt-5>main.kt</h6><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createClientInternal</span>(): Client {
 <span style=color:#66d9ef>return</span> createClient(
<span style=display:block;width:100%;background-color:#3c3d38>  Consumer {
</span><span style=display:block;width:100%;background-color:#3c3d38>   <span style=color:#66d9ef>it</span>.firstName = <span style=color:#e6db74>&#34;Alexander&#34;</span>
</span><span style=display:block;width:100%;background-color:#3c3d38>   <span style=color:#66d9ef>it</span>.lastName = <span style=color:#e6db74>&#34;Held&#34;</span>
</span>
   <span style=color:#66d9ef>val</span> twitterBuilder = TwitterBuilder()
   twitterBuilder.handle = <span style=color:#e6db74>&#34;0_alexheld&#34;</span>
<span style=display:block;width:100%;background-color:#3c3d38>   <span style=color:#66d9ef>it</span>.twitter = twitterBuilder.build()
</span>
   <span style=color:#66d9ef>val</span> companyBuilder = CompanyBuilder()
   companyBuilder.name = <span style=color:#e6db74>&#34;MegaCorp&#34;</span>
<span style=display:block;width:100%;background-color:#3c3d38>   <span style=color:#66d9ef>it</span>.company = companyBuilder.build()
</span>  }
 )
}
</code></pre></div><p>Als n√§chstes ersetzen wir in der <code>createClient</code> Funcktion den Parameter <code>c: Consumer&lt;ClientBuilder>)</code> durch <code>c: (ClientBuilder) -> Unit</code>. Wir ersetzen hier eine Implementierung des interfaces <code>Consumer&lt;ClientBuilder></code> durch eine Lamda mit einer anderen Lamda <code>(ClientBuilder) -> Unit</code>. Der Vorteil ist, dass wir nicht mehr mehr an die Implentierung der Methode <code>Consumer&lt;ClientBuilder>.accept(ClientBuilder)</code> gekoppelt sind.</p><p>Wir haben also <code>createClient</code> die <code>(ClientBuilder) -> Unit</code> als Parameter erwartet. <code>Unit</code> bedeutet in dem Fall: die Funktion soll kein R√ºckgabewert besitzen. Wir k√∂nnen also genau das selbe machen wie die ganze Zeit nur tauschen wir <code>c.accept(builder)</code> durch <code>c(builder)</code> aus.</p><h6 id=mainkt-6>main.kt</h6><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createClient</span>(c: (ClientBuilder) <span style=color:#f92672>-&gt;</span> Unit): Client {
</span> <span style=color:#66d9ef>val</span> builder = ClientBuilder()
<span style=display:block;width:100%;background-color:#3c3d38> c(builder)
</span> <span style=color:#66d9ef>return</span> builder.build()
}

<span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createClient</span>(): Client {
<span style=display:block;width:100%;background-color:#3c3d38> <span style=color:#66d9ef>return</span> createClient( {
</span>   <span style=color:#66d9ef>it</span>.firstName = <span style=color:#e6db74>&#34;Alexander&#34;</span>
   <span style=color:#66d9ef>it</span>.lastName = <span style=color:#e6db74>&#34;Held&#34;</span>

   <span style=color:#66d9ef>val</span> twitterBuilder = TwitterBuilder()
   twitterBuilder.handle = <span style=color:#e6db74>&#34;0_alexheld&#34;</span>
   <span style=color:#66d9ef>it</span>.twitter = twitterBuilder.build()

   <span style=color:#66d9ef>val</span> companyBuilder = CompanyBuilder()
   companyBuilder.name = <span style=color:#e6db74>&#34;MegaCorp&#34;</span>
   companyBuilder.city = <span style=color:#e6db74>&#34;Cologne&#34;</span>
   <span style=color:#66d9ef>it</span>.company = companyBuilder.build()
<span style=display:block;width:100%;background-color:#3c3d38>  })
</span>}
</code></pre></div><p>N√§chster kleiner Schritt ist die runden Klammern der <code>createClient()</code> Funktion zu entfernen.
Der Kotlin Compiler gestattet es runde Klammern f√ºr den letzen Parameter wegzulassen. Da wir in diesem Fall nur einen haben, k√∂nnen die Klammern ganz weg.</p><h6 id=mainkt-7>main.kt</h6><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createClient</span>(c: ClientBuilder.() <span style=color:#f92672>-&gt;</span> Unit): Client {
 <span style=color:#66d9ef>val</span> builder = ClientBuilder()
 c(builder)
 <span style=color:#66d9ef>return</span> builder.build()
}
<span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createClient</span>(): Client {
<span style=display:block;width:100%;background-color:#3c3d38> <span style=color:#66d9ef>return</span> createClient {
</span>  <span style=color:#66d9ef>it</span>.firstName = <span style=color:#e6db74>&#34;Alexander&#34;</span>
  <span style=color:#66d9ef>it</span>.lastName = <span style=color:#e6db74>&#34;Held&#34;</span>

  <span style=color:#66d9ef>val</span> twitterBuilder = TwitterBuilder()
  twitterBuilder.handle = <span style=color:#e6db74>&#34;0_alexheld&#34;</span>
  <span style=color:#66d9ef>it</span>.twitter = twitterBuilder.build()

  <span style=color:#66d9ef>val</span> companyBuilder = CompanyBuilder()
  companyBuilder.name = <span style=color:#e6db74>&#34;MegaCorp&#34;</span>
  companyBuilder.city = <span style=color:#e6db74>&#34;Cologne&#34;</span>
  <span style=color:#66d9ef>it</span>.company = companyBuilder.build()
<span style=display:block;width:100%;background-color:#3c3d38> }
</span>}
</code></pre></div><p>Und ab jetzt wird es richtig spannnend üòà</p><p>Wir ersetzen die Lamda <code>c: (ClientBuilder) -> Unit</code> durch eine <a href=https://kotlinexpertise.com/function-literals-with-receiver/>Lamda mit Empf√§nger</a> <code>c: ClientBuilder.() -> Unit</code>.</p><p>W√§hrend bei der Lamda <code>c: (ClientBuilder) -> Unit</code> ein <code>ClientBuilder</code> als Parameter erwartet wird, ist der <code>ClientBuilder</code> bei der <a href=https://kotlinexpertise.com/>Lamda mit Empf√§nger</a> derjenige der die Lamda ausf√ºhrt. Dabei kommt wieder <code>it</code> ins spiel aber da wir das auch weglassen k√∂nnen k√∂nnen wir direkt auf alle Properties des <code>ClientBuilder</code> zugreifen. √Ñhnlich wie bei einer extension Methode.</p><h6 id=mainkt-8>main.kt</h6><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=display:block;width:100%;background-color:#3c3d38><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createClient</span>(c: ClientBuilder.() <span style=color:#f92672>-&gt;</span> Unit): Client {
</span> <span style=color:#66d9ef>val</span> builder = ClientBuilder()
 c(builder)
 <span style=color:#66d9ef>return</span> builder.build()
}

<span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createClient</span>(): Client {
 <span style=color:#66d9ef>return</span> createClient {
<span style=display:block;width:100%;background-color:#3c3d38>  firstName = <span style=color:#e6db74>&#34;Alexander&#34;</span>
</span><span style=display:block;width:100%;background-color:#3c3d38>  lastName = <span style=color:#e6db74>&#34;Held&#34;</span>
</span>
  <span style=color:#66d9ef>val</span> twitterBuilder = TwitterBuilder()
  twitterBuilder.handle = <span style=color:#e6db74>&#34;0_alexheld&#34;</span>
<span style=display:block;width:100%;background-color:#3c3d38>  twitter = twitterBuilder.build()
</span>
  <span style=color:#66d9ef>val</span> companyBuilder = CompanyBuilder()
  companyBuilder.name = <span style=color:#e6db74>&#34;MegaCorp&#34;</span>
  companyBuilder.city = <span style=color:#e6db74>&#34;Cologne&#34;</span>
<span style=display:block;width:100%;background-color:#3c3d38>  company = companyBuilder.build()
</span> }
}
</code></pre></div><p>Ich gebe zu der n√§chste Code Block hat es in sich.
Schau ihn dir erstmal an und dann dekonstruieren wir den mal.</p><h6 id=mainkt-9>main.kt</h6><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>ClientBuilder</span>.twitter(c: TwitterBuilder.() <span style=color:#f92672>-&gt;</span> Unit)  {
 twitter = TwitterBuilder().apply(c).build()
}
</code></pre></div><p><strong>[1]</strong> <code>TwitterBuilder().apply(c).build()</code></p><p><a href=https://kotlinlang.org/docs/reference/scope-functions.html#apply>apply</a> hat folgende Signatur:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>inline</span> <span style=color:#66d9ef>fun</span> &lt;<span style=color:#a6e22e>T</span>&gt; <span style=color:#a6e22e>T</span>.apply(block: T.() <span style=color:#f92672>-&gt;</span> Unit): T
</code></pre></div><p>Da <code>T</code> keine Typeneinschr√§nkungen hat, l√§sst sich <code>apply</code> auf jede Instanz anwenden.
Wenn apply ausgef√ºhrt wird, wird es aus dem Kontext des Empf√§ngs aufgerufen, wendet dann die als Parameter mitgegebene Lamda <code>block: T.() -> Unit</code> auf den Empf√§nger an (mutiert seinen State) und gibt den Empf√§nger als R√ºckgabewert zur√ºck.</p><p>√úbersetzen kann man <code>TwitterBuilder().apply(c).build()</code> also <strong>sinngem√§√ü</strong> mit</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>buildTwitter</span>(c: TwitterBuilder.() <span style=color:#f92672>-&gt;</span> Unit): Twitter {
 <span style=color:#66d9ef>var</span> builder = TwitterBuilder()
 c(builder)
 <span style=color:#66d9ef>return</span> builder.build()
}
</code></pre></div><br><p><strong>[2]</strong> <code>twitter = TwitterBuilder().apply(c).build()</code></p><p>Wir sind haben weiterhin <code>ClientBuilder</code> als Empf√§nger, daher k√∂nnen wir ohne <code>this</code> oder <code>it</code> auf <code>ClientBuilder.setTwitter(t: Twitter)</code> zugreifen und ihn dem von <code>TwitterBuilder().apply(c).build()</code> gebauten <code>Twitter</code> zuweisen.</p><p>Zur Compilezeit wird <code>twitter = TwitterBuilder().apply(c).build()</code> zu <code>ContainerBuilder.setTwitter(buildTwitter(c))</code> umgewandelt. <strong>Typensicher!!</strong></p><br>Was erlaubt uns das jetzt genau?!
Wir k√∂nnen den `TwitterBuilder` aus unserer 'komplexen Business Logik' entfernen.<h6 id=mainkt-10>main.kt</h6><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin><span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createClient</span>(): Client {

 <span style=color:#66d9ef>return</span> createClient {
  firstName = <span style=color:#e6db74>&#34;Alexander&#34;</span>
  lastName = <span style=color:#e6db74>&#34;Held&#34;</span>
  twitter {
   handle = <span style=color:#e6db74>&#34;0_alexheld&#34;</span>
  }
  <span style=color:#66d9ef>val</span> companyBuilder = CompanyBuilder()
  companyBuilder.name = <span style=color:#e6db74>&#34;MegaCorp&#34;</span>
  companyBuilder.city = <span style=color:#e6db74>&#34;Cologne&#34;</span>
  company = companyBuilder.build()
 }
}

<span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createClient</span>(c: ClientBuilder.() <span style=color:#f92672>-&gt;</span> Unit): Client {
 <span style=color:#66d9ef>val</span> builder = ClientBuilder()
 c(builder)
 <span style=color:#66d9ef>return</span> builder.build()
}

<span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>ClientBuilder</span>.twitter(c: TwitterBuilder.() <span style=color:#f92672>-&gt;</span> Unit)  {
 twitter = TwitterBuilder().apply(c).build()
}

</code></pre></div><p>Wir f√ºhren den letzen Schritt jetzt auch nocheinmal mit dem <code>CompanyBuilder</code> durch und kommen zu folgendem Endergebnis.</p><h2 id=vorher>Vorher</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#66d9ef>public</span> <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>BuilderExample</span> <span style=color:#f92672>{</span>

 <span style=color:#66d9ef>public</span> Client <span style=color:#a6e22e>createClient</span><span style=color:#f92672>()</span> <span style=color:#f92672>{</span>

  var builder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ClientBuilder<span style=color:#f92672>();</span>
  builder<span style=color:#f92672>.</span><span style=color:#a6e22e>setFirstName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Alexander&#34;</span><span style=color:#f92672>);</span>
  builder<span style=color:#f92672>.</span><span style=color:#a6e22e>setLastName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Held&#34;</span><span style=color:#f92672>);</span>

  var twitterBuilder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> TwitterBuilder<span style=color:#f92672>();</span>
  twitterBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>setHandle</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;0_alexheld&#34;</span><span style=color:#f92672>);</span>
  var twitter <span style=color:#f92672>=</span> twitterBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
  builder<span style=color:#f92672>.</span><span style=color:#a6e22e>setTwitter</span><span style=color:#f92672>(</span>twitter<span style=color:#f92672>);</span>

  var companyBuilder <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> CompanyBuilder<span style=color:#f92672>();</span>
  companyBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>setName</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;MegaCorp&#34;</span><span style=color:#f92672>);</span>
  companyBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>setCity</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;Cologne&#34;</span><span style=color:#f92672>);</span>
  var company <span style=color:#f92672>=</span> companyBuilder<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
  builder<span style=color:#f92672>.</span><span style=color:#a6e22e>setCompany</span><span style=color:#f92672>(</span>company<span style=color:#f92672>);</span>

  <span style=color:#66d9ef>return</span> builder<span style=color:#f92672>.</span><span style=color:#a6e22e>build</span><span style=color:#f92672>();</span>
 <span style=color:#f92672>}</span>
<span style=color:#f92672>}</span>
</code></pre></div><h2 id=nachher>Nachher</h2><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-kotlin data-lang=kotlin>
<span style=color:#66d9ef>fun</span> <span style=color:#a6e22e>createClient</span>(): Client {
 <span style=color:#66d9ef>return</span> createClient {
  firstName = <span style=color:#e6db74>&#34;Alexander&#34;</span>
  lastName = <span style=color:#e6db74>&#34;Held&#34;</span>
  twitter {
   handle = <span style=color:#e6db74>&#34;0_alexheld&#34;</span>
  }
  company {
   name = <span style=color:#e6db74>&#34;MegaCorp&#34;</span>
   city = <span style=color:#e6db74>&#34;Cologne&#34;</span>
  }
 }
}
</code></pre></div></main><footer class=post__footer><ul class=tags><li class=tags__tag><a href=https://alexheld.io/tags/kotlin/ class=tag__link alt=kotlin.>#kotlin</a></li><li class=tags__tag><a href=https://alexheld.io/tags/java/ class=tag__link alt=java.>#java</a></li><li class=tags__tag><a href=https://alexheld.io/tags/refactor/ class=tag__link alt=refactor.>#refactor</a></li><li class=tags__tag><a href=https://alexheld.io/tags/functional-programming/ class=tag__link alt=functional-programming.>#functional-programming</a></li><li class=tags__tag><a href=https://alexheld.io/tags/clean-code/ class=tag__link alt=clean-code.>#clean-code</a></li><li class=tags__tag><a href=https://alexheld.io/tags/tutorial/ class=tag__link alt=tutorial.>#tutorial</a></li><li class=tags__tag><a href=https://alexheld.io/tags/dsl/ class=tag__link alt=dsl.>#dsl</a></li></ul></footer></article><footer class=footer><div class=footer__social><a href=https://github.com/alex-held class=footer__social__link alt=github target=_blank aria-label=https://github.com/alex-held rel=noopener><span><i class="fab fa-github"></i></span></a><a href=https://stackoverflow.com/users/10756426/alexander-held class=footer__social__link alt=stack-overflow target=_blank aria-label=https://stackoverflow.com/users/10756426/alexander-held rel=noopener><span><i class="fab fa-stack-overflow"></i></span></a><a href=https://twitter.com/0_alexheld class=footer__social__link alt=twitter target=_blank aria-label=https://twitter.com/0_alexheld rel=noopener><span><i class="fab fa-twitter"></i></span></a><a href=https://www.xing.com/profile/Alexander_Held57 class=footer__social__link alt=xing target=_blank aria-label=https://www.xing.com/profile/Alexander_Held57 rel=noopener><span><i class="fab fa-xing"></i></span></a></div><address class=footer__contact><p class=footer__contact__item><span><i class="far fa-envelope"></i></span><a href=mailto:contact@alexheld.io class=footer__contact__link alt=Email>contact@alexheld.io</a></p><p class=footer__contact__item><span><i class="fas fa-phone"></i></span><a href=tel:+49%20157771924534 class=footer__contact__link alt=Phone>+49 157771924534</a></p><p class=footer__contact__item><span><i class="fas fa-map-marker-alt"></i></span>Cologne, Germany</p></address><div class="copy footer__contact__item"><p>¬© 2020 - Alexander Held</p></div><div class=credits><a href=https://www.freepik.com/vectors/man>Man vector created by upklyak - www.freepik.com</a></div><script src=https://alexheld.io/js/bundle.min.243a483d5297388ef2f4a1b2d5e5d30218e01e8a2dfe213a376ea24d130837c860762a23e9daaa68ae3a7bcd5a3869287a14dc3b738f10486cf4e8fb4291b478.js></script><script defer src=https://use.fontawesome.com/releases/v5.7.2/js/all.js integrity=sha384-0pzryjIRos8mFBWMzSSZApWtPl/5++eIfzYmTgBBmXYdhvxPc+XcFEk+zJwDgWbP crossorigin=anonymous></script></footer></body></html>